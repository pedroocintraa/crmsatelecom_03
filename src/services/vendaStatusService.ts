import { Venda, StatusChange, StatusFlowConfig } from '../types/venda';

export class VendaStatusService {
  private static readonly STATUS_FLOW: StatusFlowConfig[] = [
    {
      status: "pendente",
      label: "Pendente",
      description: "Venda cadastrada, aguardando iniciar processo",
      color: "bg-gray-100 text-gray-800",
      icon: "clock",
      canTransitionTo: ["em_atendimento", "perdida"],
      requiredPermissions: ["ADMINISTRADOR_GERAL", "SUPERVISOR", "SUPERVISOR_EQUIPE", "VENDEDOR"],
      validationRules: {
        minDocuments: 0, // N√£o requer documentos m√≠nimos
        requiredFields: ["cliente.nome", "cliente.telefone", "planoId", "diaVencimento"]
      }
    },
    {
      status: "em_atendimento",
      label: "Em Atendimento",
      description: "Venda em processo de atendimento",
      color: "bg-blue-100 text-blue-800",
      icon: "play",
      canTransitionTo: ["auditada", "perdida"],
      requiredPermissions: ["ADMINISTRADOR_GERAL", "SUPERVISOR", "SUPERVISOR_EQUIPE"],
      validationRules: {
        minDocuments: 0, // N√£o requer documentos m√≠nimos
        requiredFields: ["cliente.nome", "cliente.telefone", "planoId", "diaVencimento"]
      }
    },
    {
      status: "auditada",
      label: "Auditada",
      description: "Venda auditada e aprovada",
      color: "bg-purple-100 text-purple-800",
      icon: "check",
      canTransitionTo: ["gerada", "perdida"],
      requiredPermissions: ["ADMINISTRADOR_GERAL", "SUPERVISOR"],
      requiresExtraData: {
        dataInstalacao: true // Requer data de instala√ß√£o
      },
      validationRules: {
        minDocuments: 0, // N√£o requer documentos m√≠nimos
        requiredFields: ["cliente.nome", "cliente.telefone", "planoId", "diaVencimento"]
      }
    },
    {
      status: "gerada",
      label: "Gerada",
      description: "Venda gerada no sistema da operadora",
      color: "bg-green-100 text-green-800",
      icon: "file-check",
      canTransitionTo: ["aguardando_habilitacao", "perdida"],
      requiredPermissions: ["ADMINISTRADOR_GERAL", "SUPERVISOR"],
      validationRules: {
        minDocuments: 0, // N√£o requer documentos m√≠nimos
        requiredFields: ["cliente.nome", "cliente.telefone", "planoId", "diaVencimento"]
      }
    },
    {
      status: "aguardando_habilitacao",
      label: "Aguardando Habilita√ß√£o",
      description: "Aguardando habilita√ß√£o da operadora",
      color: "bg-orange-100 text-orange-800",
      icon: "calendar",
      canTransitionTo: ["habilitada", "perdida"],
      requiredPermissions: ["ADMINISTRADOR_GERAL", "SUPERVISOR"],
      validationRules: {
        minDocuments: 0, // N√£o requer documentos m√≠nimos
        requiredFields: ["cliente.nome", "cliente.telefone", "planoId", "diaVencimento", "dataInstalacao"]
      }
    },
    {
      status: "habilitada",
      label: "Habilitada",
      description: "Venda habilitada e instalada",
      color: "bg-emerald-100 text-emerald-800",
      icon: "check-circle",
      canTransitionTo: [], // Status final - n√£o pode mais ser alterada
      requiredPermissions: ["ADMINISTRADOR_GERAL", "SUPERVISOR", "SUPERVISOR_EQUIPE"],
      validationRules: {
        minDocuments: 0, // N√£o requer documentos m√≠nimos
        requiredFields: ["cliente.nome", "cliente.telefone", "planoId", "diaVencimento"]
      }
    },
    {
      status: "perdida",
      label: "Perdida",
      description: "Venda perdida",
      color: "bg-red-100 text-red-800",
      icon: "x",
      canTransitionTo: [], // Status final
      requiredPermissions: ["ADMINISTRADOR_GERAL", "SUPERVISOR", "SUPERVISOR_EQUIPE"],
      requiresExtraData: {
        motivoPerda: true // Requer motivo da perda
      },
      validationRules: {
        minDocuments: 0, // N√£o requer documentos m√≠nimos
        requiredFields: ["cliente.nome", "cliente.telefone", "planoId", "diaVencimento"]
      }
    }
  ];

  /**
   * Obt√©m a configura√ß√£o de um status espec√≠fico
   */
  static getStatusConfig(status: Venda["status"]): StatusFlowConfig | undefined {
    return this.STATUS_FLOW.find(config => config.status === status);
  }

  /**
   * Verifica se uma transi√ß√£o de status √© v√°lida
   */
  static canTransition(fromStatus: Venda["status"], toStatus: Venda["status"]): boolean {
    const config = this.getStatusConfig(fromStatus);
    return config?.canTransitionTo.includes(toStatus) || false;
  }

  /**
   * Obt√©m os pr√≥ximos status poss√≠veis para uma venda
   */
  static getNextPossibleStatuses(currentStatus: Venda["status"]): Venda["status"][] {
    const config = this.getStatusConfig(currentStatus);
    return config?.canTransitionTo || [];
  }

  /**
   * Verifica se o usu√°rio tem permiss√£o para alterar o status
   */
  static hasPermissionToChangeStatus(
    currentStatus: Venda["status"], 
    targetStatus: Venda["status"], 
    userRole: string
  ): boolean {
    const config = this.getStatusConfig(currentStatus);
    const targetConfig = this.getStatusConfig(targetStatus);
    
    if (!config || !targetConfig) return false;
    
    // Verificar se a transi√ß√£o √© v√°lida
    if (!this.canTransition(currentStatus, targetStatus)) return false;
    
    // Verificar permiss√µes do usu√°rio
    return targetConfig.requiredPermissions.includes(userRole);
  }

  /**
   * Valida se uma venda pode ser movida para um novo status
   */
  static validateStatusTransition(
    venda: Venda, 
    targetStatus: Venda["status"], 
    userRole: string,
    extraData?: any
  ): { valid: boolean; errors: string[] } {
    const errors: string[] = [];
    
    console.log('üîç validateStatusTransition Debug:', {
      vendaStatus: venda.status,
      targetStatus,
      userRole,
      extraData,
      vendaDataInstalacao: venda.dataInstalacao
    });
    
    // Verificar permiss√µes
    if (!this.hasPermissionToChangeStatus(venda.status, targetStatus, userRole)) {
      errors.push("Voc√™ n√£o tem permiss√£o para realizar esta transi√ß√£o");
    }
    
    // Verificar se a transi√ß√£o √© v√°lida
    if (!this.canTransition(venda.status, targetStatus)) {
      errors.push("Transi√ß√£o de status inv√°lida");
    }
    
    // Obter configura√ß√£o do status de destino
    const targetConfig = this.getStatusConfig(targetStatus);
    if (!targetConfig) {
      errors.push("Status de destino inv√°lido");
      return { valid: false, errors };
    }
    
    console.log('üîç Target Config:', {
      targetConfig,
      requiresExtraData: targetConfig.requiresExtraData,
      validationRules: targetConfig.validationRules
    });
    
    // Validar campos obrigat√≥rios (excluindo campos que ser√£o fornecidos via extraData)
    if (targetConfig.validationRules?.requiredFields) {
      console.log('üîç Validando campos obrigat√≥rios:', targetConfig.validationRules.requiredFields);
      
      for (const field of targetConfig.validationRules.requiredFields) {
        console.log(`üîç Verificando campo: ${field}`);
        
        // Se o campo √© fornecido via extraData, n√£o validar na venda atual
        if (targetConfig.requiresExtraData?.dataInstalacao && field === 'dataInstalacao') {
          console.log('üîç Pulando valida√ß√£o de dataInstalacao - ser√° fornecido via extraData');
          continue; // Pular valida√ß√£o deste campo na venda atual
        }
        
        const hasField = this.hasRequiredField(venda, field);
        console.log(`üîç Campo ${field}: ${hasField ? 'OK' : 'FALTANDO'}`);
        
        if (!hasField) {
          errors.push(`Campo obrigat√≥rio n√£o preenchido: ${field}`);
        }
      }
    }
    
    // Validar dados extras obrigat√≥rios
    if (targetConfig.requiresExtraData) {
      console.log('üîç Validando dados extras:', targetConfig.requiresExtraData);
      
      if (targetConfig.requiresExtraData.motivoPerda && !extraData?.motivoPerda) {
        errors.push("Motivo da perda √© obrigat√≥rio");
      }
      if (targetConfig.requiresExtraData.dataInstalacao && !extraData?.dataInstalacao) {
        errors.push("Data de instala√ß√£o √© obrigat√≥ria");
      }
      if (targetConfig.requiresExtraData.observacoes && !extraData?.observacoes) {
        errors.push("Observa√ß√µes s√£o obrigat√≥rias");
      }
    }
    
    console.log('üîç Resultado da valida√ß√£o:', { valid: errors.length === 0, errors });
    return { valid: errors.length === 0, errors };
  }

  /**
   * Verifica se um campo obrigat√≥rio est√° preenchido
   */
  private static hasRequiredField(venda: Venda, fieldPath: string): boolean {
    const fields = fieldPath.split('.');
    let value: any = venda;
    
    for (const field of fields) {
      if (value && typeof value === 'object' && field in value) {
        value = value[field];
      } else {
        return false;
      }
    }
    
    return value !== undefined && value !== null && value !== '';
  }

  /**
   * Cria um registro de mudan√ßa de status
   */
  static createStatusChange(
    newStatus: Venda["status"],
    userId: string,
    userName: string,
    extraData?: any
  ): StatusChange {
    return {
      status: newStatus,
      timestamp: new Date().toISOString(),
      userId,
      userName,
      extraData
    };
  }

  /**
   * Obt√©m o hist√≥rico de mudan√ßas de status
   */
  static getStatusHistory(venda: Venda): StatusChange[] {
    return venda.historicoStatus || [];
  }

  /**
   * Obt√©m a √∫ltima mudan√ßa de status
   */
  static getLastStatusChange(venda: Venda): StatusChange | null {
    const history = this.getStatusHistory(venda);
    return history.length > 0 ? history[history.length - 1] : null;
  }

  /**
   * Obt√©m todas as configura√ß√µes de status
   */
  static getAllStatusConfigs(): StatusFlowConfig[] {
    return this.STATUS_FLOW;
  }

  /**
   * Calcula o progresso da venda (0-100)
   */
  static getVendaProgress(venda: Venda): number {
    const statusOrder = [
      "pendente",
      "em_atendimento", 
      "auditada",
      "gerada",
      "aguardando_habilitacao",
      "habilitada"
    ];
    
    const currentIndex = statusOrder.indexOf(venda.status);
    if (currentIndex === -1) return 0;
    
    return Math.round(((currentIndex + 1) / statusOrder.length) * 100);
  }

  /**
   * Verifica se um status √© final
   */
  static isFinalStatus(status: Venda["status"]): boolean {
    const config = this.getStatusConfig(status);
    return config?.canTransitionTo.length === 0;
  }

  /**
   * Obt√©m o tempo desde a √∫ltima mudan√ßa
   */
  static getTimeSinceLastChange(venda: Venda): string {
    const lastChange = this.getLastStatusChange(venda);
    if (!lastChange) return "Nunca";
    
    const now = new Date();
    const changeTime = new Date(lastChange.timestamp);
    const diffMs = now.getTime() - changeTime.getTime();
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return "Hoje";
    if (diffDays === 1) return "Ontem";
    return `${diffDays} dias atr√°s`;
  }

  /**
   * Verifica se uma venda gerada deve ficar vermelha (mais de 2 dias)
   */
  static shouldShowAsUrgent(venda: Venda): boolean {
    if (venda.status !== "gerada") return false;
    
    const lastChange = this.getLastStatusChange(venda);
    if (!lastChange) return false;
    
    const now = new Date();
    const changeTime = new Date(lastChange.timestamp);
    const diffMs = now.getTime() - changeTime.getTime();
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    return diffDays > 2;
  }

  /**
   * Verifica se uma venda gerada deve ir automaticamente para "aguardando_habilitacao"
   */
  static shouldAutoTransitionToAwaiting(venda: Venda): boolean {
    if (venda.status !== "gerada") return false;
    
    // Se tem data de instala√ß√£o, deve ir para aguardando_habilitacao
    return venda.dataInstalacao && venda.dataInstalacao.trim() !== '';
  }

  /**
   * Processa dados extras quando o status √© alterado
   */
  static async processExtraDataOnStatusChange(
    venda: Venda,
    newStatus: Venda["status"],
    extraData?: any
  ): Promise<Partial<Venda>> {
    console.log('üîç processExtraDataOnStatusChange:', { newStatus, extraData });
    
    const updates: Partial<Venda> = {};

    // Se est√° mudando para "habilitada", definir dataInstalacaoReal
    if (newStatus === "habilitada" && !venda.dataInstalacaoReal) {
      const { getDataAtualBrasil } = await import('@/lib/utils');
      updates.dataInstalacaoReal = getDataAtualBrasil();
      console.log('üîç Definindo dataInstalacaoReal para habilitada');
    }

    // Se est√° mudando para "perdida", salvar motivoPerda
    if (newStatus === "perdida" && extraData?.motivoPerda) {
      updates.motivoPerda = extraData.motivoPerda;
      console.log('üîç Salvando motivoPerda para perdida');
    }

    // Se est√° mudando para "auditada" e tem dataInstalacao nos dados extras
    if (newStatus === "auditada" && extraData?.dataInstalacao) {
      updates.dataInstalacao = extraData.dataInstalacao;
      console.log('üîç Salvando dataInstalacao para auditada:', extraData.dataInstalacao);
      console.log('üîç Tipo da data:', typeof extraData.dataInstalacao);
      console.log('üîç Updates completo:', updates);
    }

    console.log('üîç Updates processados:', updates);
    return updates;
  }
} 